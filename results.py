# Entry Point of the Project

# # Text Files to Prepare before Executing the results.py Funtions
# 1. Receiver List - Contains the Phone Number of the Student(+91XXXXXXXXXX)
# 2. USN List - Contains the USNs of the Student whose Results have to be gathered(1MV21CSXXX)
# 3. Name List - Contains the Names of the Students

# # Required libraries (Available in the Requirements.txt File)
# 1. selenium 
# 2. pywhatkit 
# 3. opencv

##NOTE: The script assumes that the Chrome browser is pre-installed on the system.
##      If not, Please download and install the Chrome browser from https://www.google.com/chrome/ 

from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
import time, os
from captcha_to_text import crop_result
from captcha_text import tries_to_solve
from msgwa import send_msg
import warnings
warnings.filterwarnings("ignore")


#Equiping the Driver with the right URL and Assertions
driver = webdriver.Chrome()
driver.get("https://results.vtu.ac.in/JJEcbcs24/index.php")
assert "Result" in driver.title

#Text Files regarding the Information of the Students to send on WhatsApp
receiver_list = open("receiver_list.txt", 'r').readlines()              
usn_list = open("usn_list.txt", 'r').readlines()                       
name_list = open("name_list.txt", 'r').readlines()                      

#Starting the Loop for Extracting the Result of Students
i = 0
for _ in range(len(usn_list)):
    try:

        #Fetching the Captcha Image and Processing and Also sends in the USN and Captcha for Validation.
        captcha_text = tries_to_solve(driver, usn_list[i])

        #Ending the Process if Captcha is not Solved, Recommend try again after some time.
        if not captcha_text:
            print("Captcha Solving or USN Passing is Causing an Error!!!")
            driver.quit()

        driver.implicitly_wait(5)
        #Result Screenshoting and Cropping
        body_ss = driver.find_element(By.TAG_NAME, "body")
        width = body_ss.size['width']
        height = body_ss.size['height']

        driver.execute_script("document.body.style.zoom='65%'")      #Zooming out the Driver Window to fit in the Data
        usn = usn_list[i].rstrip("\n")
        body_ss.screenshot("result/{usnn}.png".format(usnn = usn))   #Screenshoting the Result and saving it as usn.png
        crop_result("result/{usnn}.png".format(usnn = usn))          #Cropping the Result Screenshot into correct ratio
        
        i += 1
        #refreshing the Webpage before Processing the Elements
        driver.back()
        assert "No results found." not in driver.page_source
        # time.sleep(4)

    except Exception as e:
        print(e)


#SGPA Calculation and storing it in a Text File
driver.get("https://www.vtulife.in/vtu-results/JJEcbcs24")
with open("sgpa_list1.txt", 'w') as sgpa_file:
    for j in range(len(usn_list)):
        usn = usn_list[j].rstrip("\n")

        #Finding the USN Element, clear it and Send in the USN as in the List
        vl_usn_elem = driver.find_element(By.ID, "id_usn")
        vl_usn_elem.clear()
        vl_usn_elem.send_keys(usn)

        #Finding the Submit Button and Clicking it
        vl_submit_btn = driver.find_element(By.CLASS_NAME, "btn.btn-success.svelte-1k0s61x").click()
        time.sleep(1)
        
        #Fetching the SGPA of a particular USN
        vl_sgpa = driver.find_element(By.CLASS_NAME, "text-success.fw-bold.svelte-9e3epj")
        sgpa_file.writelines("{}\n".format(vl_sgpa.text))

#Opening the SGPA Text file as a list to iterate through each line
sgpa_list = open("sgpa_list1.txt", 'r').readlines()


#Whatsapp Messaging Integration
for x in range(len(receiver_list)):

    #Converting the Values by removing the Next line character generated by readlines() method
    receiver = receiver_list[x].rstrip("\n")
    usn = usn_list[x].rstrip("\n")
    name = name_list[x].rstrip("\n")
    sgpa = sgpa_list[x].rstrip("\n")

    #Sending the Message attaching the required details(Name, Phone, Img, SGPA)
    send_msg(receiver, f"result/{usn}.png", name, sgpa)